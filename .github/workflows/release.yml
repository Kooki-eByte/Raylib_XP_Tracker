name: Build Multi-Platform Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  # --------------------------
  # WINDOWS BUILD JOB
  # --------------------------
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up MSYS2 with MinGW64
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >
            mingw-w64-x86_64-gcc
            make
            mingw-w64-x86_64-raylib
            mingw-w64-x86_64-glfw
            mingw-w64-x86_64-pkg-config
            zip

      - name: Build Windows Binary
        shell: msys2 {0}
        env:
          OS: Windows_NT
        run: |
          mkdir -p bin
          make ./bin/xp_tracker.exe

      - name: Collect DLLs and Package ZIP
        shell: msys2 {0}
        run: |
          mkdir -p release
          cp bin/xp_tracker.exe release/
          find /mingw64/bin -name "libraylib.dll" -exec cp {} release/ \;
          find /mingw64/bin -name "glfw3.dll" -exec cp {} release/ \;
          cp /mingw64/bin/libwinpthread-1.dll release/ || true
          cp /mingw64/bin/libgcc_s_seh-1.dll release/ || true
          cp /mingw64/bin/libstdc++-6.dll release/ || true
          cd release
          zip -r XP_Tracker_Windows_x64.zip *

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: XP_Tracker_Windows_x64
          path: release/XP_Tracker_Windows_x64.zip

  # --------------------------
  # UBUNTU (DEBIAN) LINUX BUILD
  # --------------------------
  build-linux-ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            make \
            gcc \
            libraylib-dev \
            libglfw3-dev \
            zip \
            tar

      - name: Build Linux Binary
        env:
          OS: Linux
        run: |
          mkdir -p bin
          make ./bin/xp_tracker

      - name: Package Linux Ubuntu Artifacts
        run: |
          mkdir -p release
          cp bin/xp_tracker release/
          cd release
          tar -czvf XP_Tracker_Linux_Ubuntu_x64.tar.gz xp_tracker
          zip XP_Tracker_Linux_Ubuntu_x64.zip xp_tracker

      - name: Upload Linux Ubuntu Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: XP_Tracker_Linux_Ubuntu_x64
          path: release/*

  # --------------------------
  # ARCH LINUX BUILD
  # --------------------------
  build-linux-arch:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Install Dependencies
        run: |
          pacman -Sy --noconfirm \
            base-devel \
            gcc \
            make \
            raylib \
            glfw-x11 \
            zip \
            tar \
            git

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Linux Binary
        env:
          OS: Linux
        run: |
          mkdir -p bin
          make ./bin/xp_tracker

      - name: Package Linux Arch Artifacts
        run: |
          mkdir -p release
          cp bin/xp_tracker release/
          cd release
          tar -czvf XP_Tracker_Linux_Arch_x64.tar.gz xp_tracker
          zip XP_Tracker_Linux_Arch_x64.zip xp_tracker

      - name: Upload Linux Arch Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: XP_Tracker_Linux_Arch_x64
          path: release/*

  # --------------------------
  # CREATE RELEASE WITH ALL ARTIFACTS
  # --------------------------
  release:
    needs:
      - build-windows
      - build-linux-ubuntu
      - build-linux-arch
    runs-on: ubuntu-latest

    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: XP_Tracker_Windows_x64
          path: artifacts/

      - name: Download Ubuntu Artifact
        uses: actions/download-artifact@v4
        with:
          name: XP_Tracker_Linux_Ubuntu_x64
          path: artifacts/

      - name: Download Arch Artifact
        uses: actions/download-artifact@v4
        with:
          name: XP_Tracker_Linux_Arch_x64
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
