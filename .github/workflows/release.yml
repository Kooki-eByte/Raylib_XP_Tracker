name: Build Windows Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up MSYS2 with MinGW64
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >
            mingw-w64-x86_64-gcc
            make
            mingw-w64-x86_64-raylib
            mingw-w64-x86_64-glfw
            mingw-w64-x86_64-pkg-config
            zip

      - name: Verify toolchain
        shell: msys2 {0}
        run: |
          which gcc
          gcc --version
          which make
          pkg-config --modversion raylib
          pkg-config --modversion glfw3

      - name: Create bin directory
        shell: msys2 {0}
        run: mkdir -p bin

      - name: Build Windows Binary
        shell: msys2 {0}
        env:
          OS: Windows_NT
        run: |
          make ./bin/xp_tracker.exe
        
      - name: Sign Windows Binary
        shell: powershell
        run: |
          # Decode the PFX secret to a file
          $pfxPath = "$env:RUNNER_TEMP\code_sign.pfx"
          [System.IO.File]::WriteAllBytes($pfxPath, [System.Convert]::FromBase64String("${{ secrets.SIGN_CERT_PFX }}"))

          # Locate signtool.exe automatically
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe | Select-Object -First 1
          if (-not $signtool) { throw "signtool.exe not found on runner" }

          # Sign the executable
          & $signtool.FullName sign `
            /f $pfxPath `
            /p "${{ secrets.SIGN_CERT_PASSWORD }}" `
            /tr http://timestamp.digicert.com `
            /td sha256 `
            /fd sha256 `
            bin\xp_tracker.exe

          # Optional: verify signature
          & $signtool.FullName verify /pa /v bin\xp_tracker.exe

      - name: Collect DLLs and package ZIP
        shell: msys2 {0}
        run: |
          mkdir -p release
          cp bin/xp_tracker.exe release/
          # Copy raylib and glfw DLLs dynamically
          find /mingw64/bin -name "libraylib.dll" -exec cp {} release/ \;
          find /mingw64/bin -name "glfw3.dll" -exec cp {} release/ \;
          # Optional: copy other necessary MinGW DLLs
          cp /mingw64/bin/libwinpthread-1.dll release/ || true
          cp /mingw64/bin/libgcc_s_seh-1.dll release/ || true
          cp /mingw64/bin/libstdc++-6.dll release/ || true
          cd release
          zip -r Raylib_XP_Tracker_Windows_x64.zip *

      - name: Upload ZIP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: XP_Tracker_Windows_x64
          path: release/XP_Tracker_Windows_x64.zip

  release-windows:
    needs: build-windows
    runs-on: ubuntu-latest

    steps:
      - name: Download ZIP Artifact
        uses: actions/download-artifact@v4
        with:
          name: XP_Tracker_Windows_x64

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: XP_Tracker_Windows_x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
